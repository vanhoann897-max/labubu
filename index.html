<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiikawa RPG - C·ª≠a H√†ng & Chi·∫øn ƒê·∫•u Boss</title>
    <!-- Th∆∞ vi·ªán Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Thi·∫øt l·∫≠p c·∫•u h√¨nh Firebase
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            setLogLevel('Debug'); // B·∫≠t log debug cho Firestore
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // X·ª≠ l√Ω x√°c th·ª±c
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    window.userId = user.uid;
                    console.log("Firebase Auth OK. User ID:", window.userId);
                    if (window.onFirebaseReady) {
                        window.onFirebaseReady();
                    }
                } else if (!window.authReadyAttempted) {
                    // C·ªë g·∫Øng ƒëƒÉng nh·∫≠p v·ªõi token t√πy ch·ªânh ho·∫∑c ·∫©n danh
                    window.authReadyAttempted = true;
                    if (initialAuthToken) {
                        signInWithCustomToken(window.auth, initialAuthToken).catch(error => {
                            console.error("L·ªói ƒëƒÉng nh·∫≠p v·ªõi token t√πy ch·ªânh:", error);
                            signInAnonymously(window.auth);
                        });
                    } else {
                        signInAnonymously(window.auth);
                    }
                }
            });
        } else {
            console.error("Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh Firebase.");
            window.userId = crypto.randomUUID(); // D√πng ID ng·∫´u nhi√™n n·∫øu kh√¥ng c√≥ Firebase
            window.isFirebaseAvailable = false;
        }

    </script>
    <!-- Th∆∞ vi·ªán Tone.js cho √¢m nh·∫°c -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Mali:wght@400;700&display=swap');

        :root {
            --chiikawa-pink: #fbcfe8;
            --hachiware-blue: #a5f3fc;
            --usagi-yellow: #fde68a;
            --primary-bg: #fff;
            --secondary-bg: #f9f9f9;
            --border-color: #333;
            --text-color: #1f2937;
            --coin-color: #f59e0b; /* V√†ng ƒë·ªìng */
        }

        body {
            font-family: 'Mali', cursive, 'Inter', sans-serif;
            background-color: var(--chiikawa-pink);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .game-container {
            background-color: var(--primary-bg);
            border: 5px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 10px 10px 0px 0px var(--border-color);
            padding: 20px;
            max-width: 650px;
            width: 100%;
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            gap: 15px;
        }

        h1 {
            font-size: 2.2rem;
            text-align: center;
            color: var(--text-color);
            text-shadow: 2px 2px 0 var(--chiikawa-pink);
            margin-top: 0;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .character-selection, .controls, .combat-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button, .character-card {
            background-color: var(--secondary-bg);
            border: 3px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 15px;
            font-family: 'Mali', cursive;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 3px 3px 0 var(--border-color);
        }

        button:hover, .character-card:hover {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0 var(--border-color);
        }

        button:active, .character-card.selected, .shop-item-card:active {
            transform: translate(3px, 3px);
            box-shadow: none;
            background-color: var(--usagi-yellow);
        }

        .character-card {
            width: 100px;
            text-align: center;
            padding: 15px 10px;
        }
        
        /* CSS M·ªöI cho H√¨nh ·∫¢nh Nh√¢n V·∫≠t */
        .char-icon-img {
            width: 50px; /* K√≠ch th∆∞·ªõc h√¨nh ·∫£nh */
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
            margin: 0 auto 5px auto;
            display: block;
        }
        /* HACK: n·∫øu ·∫£nh b·ªã l·ªói (ch·ªâ hi·ªán placeholder) th√¨ d√πng emoji t·∫°m */
        .char-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 5px;
        }


        .chiikawa-color { background-color: var(--chiikawa-pink); }
        .hachiware-color { background-color: var(--hachiware-blue); }
        .usagi-color { background-color: var(--usagi-yellow); }

        .game-status {
            padding: 15px;
            background-color: var(--secondary-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
        }

        .stat-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        #player-chicoin {
            color: var(--coin-color);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .log-area {
            height: 150px;
            overflow-y: auto;
            border: 2px inset var(--border-color);
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 8px;
            white-space: pre-wrap;
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1);
        }

        .log-area p {
            margin: 0 0 5px 0;
            line-height: 1.2;
        }

        .message-info { color: green; }
        .message-warn { color: orange; }
        .message-error { color: red; font-weight: bold; }
        .message-quest { color: purple; font-weight: bold; }
        .message-damage { color: #880000; font-weight: 700; }
        .message-coin { color: var(--coin-color); font-weight: 700; }
        .message-effect { color: #008888; font-weight: 700; }
        
        /* Hi·ªÉn th·ªã HP c·ªßa Boss/Enemy trong tr·∫≠n ƒë·∫•u */
        #enemy-status {
            margin-top: 15px;
            padding: 10px;
            border: 2px solid #a53b3b;
            background-color: #fcebeb;
            border-radius: 8px;
            font-weight: bold;
        }

        .inventory {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .inventory-item {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #eee;
            font-size: 0.9rem;
        }

        /* --- SHOP STYLES --- */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .shop-item-card {
            background-color: #e0f2fe; /* Light blue background for shop */
            border: 3px solid var(--border-color);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 3px 3px 0 var(--border-color);
        }

        .shop-item-card h4 {
            margin: 5px 0 5px 0;
            font-size: 1.1rem;
        }

        .shop-item-card p {
            margin: 0;
            font-size: 0.85rem;
            color: #4b5563;
        }

        .shop-price {
            font-weight: 700;
            color: var(--coin-color);
            margin-top: 5px;
        }

        .shop-subtitle {
            font-size: 1.2rem;
            font-weight: 700;
            margin-top: 15px;
            border-bottom: 1px dashed #999;
            padding-bottom: 5px;
        }

        #saveLoadStatus {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }
        
        /* N√∫t chi·∫øn ƒë·∫•u */
        .combat-actions button {
            padding: 10px;
            flex-grow: 1;
            min-width: 120px;
            max-width: 150px;
            background-color: #fef3c7; /* M√†u nh·∫°t cho action */
        }
        
        .combat-actions .attack-btn {
            max-width: none;
            flex-grow: 2;
            background-color: #ff6666;
        }
        
        /* Responsive adjustments */
        @media (max-width: 480px) {
            h1 { font-size: 1.8rem; }
            .character-card { width: 80px; padding: 10px 5px; }
            button { padding: 8px 12px; font-size: 0.9rem; }
            .shop-grid { grid-template-columns: 1fr 1fr; }
            .combat-actions { flex-direction: column; }
            .combat-actions button { max-width: 100%; }
        }
    </style>
</head>
<body>

    <div class="game-container">
        <h1>‚ú® Chiikawa RPG ‚ú®</h1>

        <!-- Khu v·ª±c Ti·ªÅn t·ªá -->
        <div class="stat-line game-status" id="currencyDisplay" style="text-align: center; padding: 8px;">
            <span>üí∞ Chicoin:</span>
            <span id="player-chicoin">0</span>
        </div>

        <!-- M√†n h√¨nh ch√≠nh (Thay th·∫ø cho gameScreen) -->
        <div id="gameViewContainer">
            <!-- 1. M√ÄN H√åNH CH·ªåN NH√ÇN V·∫¨T -->
            <div id="charSelection" style="display: block;">
                <div class="section-title">Ch·ªçn Nh√¢n V·∫≠t Kh·ªüi ƒê·∫ßu</div>
                <div class="character-selection">
                    <!-- S·∫Øp x·∫øp l·∫°i theo y√™u c·∫ßu: Hachiware, Usagi, Chiikawa -->
                    <div class="character-card hachiware-color" data-char="Hachiware" onclick="selectCharacter('Hachiware')">
                        <img class="char-icon-img" src="uploaded:image_1937f8.png-9a2d065e-9dd0-4649-ad2e-b75ffeff55cf" alt="Hachiware" onerror="this.outerHTML='<span class=\'char-icon\'>üõ†Ô∏è</span>'">
                        Hachiware
                    </div>
                    <div class="character-card usagi-color" data-char="Usagi" onclick="selectCharacter('Usagi')">
                        <img class="char-icon-img" src="uploaded:image_1937da.png-21f9a213-c10c-4788-9b6e-d25be7a33c04" alt="Usagi" onerror="this.outerHTML='<span class=\'char-icon\'>üê∞</span>'">
                        Usagi
                    </div>
                    <div class="character-card chiikawa-color" data-char="Chiikawa" onclick="selectCharacter('Chiikawa')">
                        <img class="char-icon-img" src="uploaded:image_1937d5.png-4a4b9a35-9863-4748-87eb-5ce16baafd83" alt="Chiikawa" onerror="this.outerHTML='<span class=\'char-icon\'>üíß</span>'">
                        Chiikawa
                    </div>
                </div>
            </div>

            <!-- 2. M√ÄN H√åNH GAME CH√çNH -->
            <div id="mainGameView" style="display: none;">
                <div class="section-title">Th√¥ng Tin Nh√¢n V·∫≠t</div>
                <div class="game-status">
                    <div class="stat-line">
                        <span>Nh√¢n V·∫≠t:</span>
                        <span id="player-name"></span>
                    </div>
                    <div class="stat-line">
                        <span>C·∫•p ƒë·ªô:</span>
                        <span id="player-level"></span>
                    </div>
                    <div class="stat-line">
                        <span>HP:</span>
                        <span id="player-hp"></span>
                    </div>
                    <div class="stat-line">
                        <span>S·ª©c t·∫•n c√¥ng (ATK):</span>
                        <span id="player-atk"></span>
                    </div>
                    <div class="stat-line">
                        <span>Ph√≤ng th·ªß (DEF):</span>
                        <span id="player-def"></span>
                    </div>
                    <div class="stat-line">
                        <span>EXP:</span>
                        <span id="player-exp"></span>
                    </div>
                    <div class="stat-line">
                        <span>V≈© kh√≠:</span>
                        <span id="player-weapon"></span>
                    </div>
                    <div class="stat-line">
                        <span>Hi·ªáu ·ª©ng:</span>
                        <span id="player-effects" style="color: #008888;"></span>
                    </div>
                    <!-- Khu v·ª±c hi·ªÉn th·ªã HP ƒë·ªãch th·ªß (ch·ªâ hi·ªÉn th·ªã trong tr·∫≠n ƒë·∫•u) -->
                    <div id="enemy-status" style="display:none;">
                        <div class="stat-line">
                            <span id="enemy-name-display"></span>
                            <span id="enemy-hp-display"></span>
                        </div>
                    </div>
                    <div class="section-title" style="margin-top: 10px; border-bottom: none;">T√∫i ƒë·ªì</div>
                    <div class="inventory" id="player-inventory">
                        <!-- Items here -->
                    </div>
                </div>
            </div>
            
            <!-- 3. M√ÄN H√åNH SHOP -->
            <div id="shopView" style="display: none;">
                <div class="section-title">üõí C·ª≠a H√†ng Chicoin</div>

                <div class="shop-subtitle">üçî ƒê·ªì ƒÇn (H·ªìi M√°u)</div>
                <div class="shop-grid" id="foodShopGrid">
                    <!-- Food items injected here -->
                </div>

                <div class="shop-subtitle">‚öîÔ∏è V≈© Kh√≠</div>
                <div class="shop-grid" id="weaponShopGrid">
                    <!-- Weapon items injected here -->
                </div>
            </div>

            <!-- 4. M√ÄN H√åNH BOSS CH√çNH -->
            <div id="finalBossView" style="display: none;">
                 <div class="section-title">üî• Th·ª≠ Th√°ch Cu·ªëi C√πng: Boss Ch√≠nh</div>
                 <p style="text-align: center; color: #880000; font-weight: bold;">
                    B·∫°n ƒë√£ s·∫µn s√†ng ƒë·ªëi m·∫∑t v·ªõi nh·ªØng m·ªëi nguy hi·ªÉm l·ªõn nh·∫•t?
                 </p>
                 <div class="shop-grid" id="finalBossGrid">
                     <!-- Bosses injected here -->
                 </div>
            </div>

        </div>

        <!-- Khu v·ª±c Nh·∫≠t k√Ω Game -->
        <div class="section-title">Nh·∫≠t K√Ω & Nhi·ªám V·ª•</div>
        <div class="log-area" id="gameLog">
            <p class="message-info">Ch√†o m·ª´ng ƒë·∫øn v·ªõi Cu·ªôc Phi√™u L∆∞u C√πng Chiikawa!</p>
            <p class="message-info">Vui l√≤ng ch·ªçn nh√¢n v·∫≠t ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
        </div>

        <!-- Khu v·ª±c ƒêi·ªÅu khi·ªÉn -->
        <div class="section-title">Thao T√°c</div>
        <div class="controls" id="gameControls">
            <button onclick="toggleMusic()" id="musicBtn">üîá B·∫≠t Nh·∫°c</button>
        </div>

        <p id="saveLoadStatus">ƒêang ch·ªù k·∫øt n·ªëi Firebase...</p>
        <p style="text-align: center; font-size: 0.8rem; color: #999;">UserID: <span id="displayUserId">...</span></p>

    </div>

    <script>
        // --- C√ÅC ƒê·ªäNH NGHƒ®A C∆† B·∫¢N C·ª¶A GAME ---

        let game;
        const GAME_DATA_COLLECTION = "chiikawa-rpg-data";
        
        let isInFight = false;
        let cakeUsedInFight = false;
        let currentView = 'selection'; 
        let currentEnemy = null; 

        // H·∫±ng s·ªë cho c√°c hi·ªáu ·ª©ng chi·∫øn thu·∫≠t
        const COMBAT_EFFECTS = {
            FOCUS_DAMAGE_MULTIPLIER: 1.5,
            DEFEND_DEFENSE_MULTIPLIER: 2.0,
        };

        // C√¢u c·ª≠a mi·ªáng nh√¢n v·∫≠t
        const CATCHPHRASES = {
            Chiikawa: "Haaa?",
            Hachiware: "Oi!",
            Usagi: "Yaha!"
        };

        // ƒêI·ªÄU CH·ªàNH: Th√™m URL h√¨nh ·∫£nh nh√¢n v·∫≠t
        const BASE_STATS = {
            Chiikawa: { icon: 'üíß', hp: 150, atk: 15, def: 15, baseColor: 'var(--chiikawa-pink)', imgUrl: 'uploaded:image_1937d5.png-4a4b9a35-9863-4748-87eb-5ce16baafd83' },
            Hachiware: { icon: 'üõ†Ô∏è', hp: 180, atk: 17, def: 10, baseColor: 'var(--hachiware-blue)', imgUrl: 'uploaded:image_1937f8.png-9a2d065e-9dd0-4649-ad2e-b75ffeff55cf' },
            Usagi: { icon: 'üê∞', hp: 120, atk: 20, def: 8, baseColor: 'var(--usagi-yellow)', imgUrl: 'uploaded:image_1937da.png-21f9a213-c10c-4788-9b6e-d25be7a33c04' },
        };
        
        // --- D·ªÆ LI·ªÜU QU√ÅI TH∆Ø·ªúNG (20 LO·∫†I) ---
        // S√°t th∆∞∆°ng, HP v√† EXP th·∫•p.
        const NORMAL_ENEMY_POOL = {
            'S√¢u B∆∞·ªõm üêõ': { hp: 20, atk: 10, def: 0, exp: 10, dropCoin: { min: 5, max: 10 }, evasion: 0.2, special: "N√© tr√°nh 20%" },
            'Chu·ªôt Nh·∫Øt üê≠': { hp: 15, atk: 12, def: 0, exp: 8, dropCoin: { min: 4, max: 9 }, special: "ƒê√°nh nhanh" },
            'Chim C√°nh C·ª•t L·ª≠a üî•': { hp: 25, atk: 8, def: 5, exp: 12, dropCoin: { min: 6, max: 11 }, special: "Gi√°p y·∫øu" },
            'Th·∫±n L·∫±n Xanh ü¶é': { hp: 30, atk: 11, def: 2, exp: 15, dropCoin: { min: 7, max: 13 }, special: "HP cao" },
            'Cua Nh·ªè ü¶Ä': { hp: 22, atk: 10, def: 4, exp: 11, dropCoin: { min: 5, max: 10 }, special: "Ph√≤ng th·ªß nh·ªè" },
            '·ªêc S√™n T√≠m üêå': { hp: 40, atk: 5, def: 8, exp: 18, dropCoin: { min: 8, max: 15 }, special: "C·ª±c k·ª≥ tr√¢u" },
            'B·ªç C√°nh C·ª©ng üêû': { hp: 28, atk: 15, def: 1, exp: 14, dropCoin: { min: 6, max: 12 }, special: "S√°t th∆∞∆°ng cao" },
            'D∆°i ƒê√™m ü¶á': { hp: 18, atk: 13, def: 0, exp: 9, dropCoin: { min: 4, max: 8 }, evasion: 0.3, special: "N√© tr√°nh 30%" },
            'G·∫•u B√¥ng R√°ch üß∏': { hp: 35, atk: 9, def: 3, exp: 16, dropCoin: { min: 7, max: 14 }, special: "T·∫•n c√¥ng ng·∫´u nhi√™n" },
            'M·ª±c N∆∞·ªõc Ng·ªçt ü¶ë': { hp: 26, atk: 11, def: 0, exp: 13, dropCoin: { min: 5, max: 11 }, special: "ƒê√≤n ƒë√°nh g√¢y cho√°ng nh·∫π" },
            'Linh Mi√™u N√∫i üêÜ': { hp: 20, atk: 16, def: 0, exp: 15, dropCoin: { min: 8, max: 16 }, special: "S√°t th∆∞∆°ng ch√≠ m·∫°ng" },
            'R·∫Øn ƒê·∫•t üêç': { hp: 32, atk: 10, def: 3, exp: 14, dropCoin: { min: 6, max: 13 }, special: "C√≥ ƒë·ªôc (s√°t th∆∞∆°ng nh·ªè theo th·ªùi gian)" },
            'H·ªï L·ª≠a Nh·ªè üêØ': { hp: 27, atk: 14, def: 1, exp: 16, dropCoin: { min: 7, max: 15 }, special: "T·∫•n c√¥ng nhanh" },
            'Kh·ªâ Nhanh Nh·∫πn üêí': { hp: 24, atk: 13, def: 0, exp: 12, dropCoin: { min: 5, max: 11 }, evasion: 0.25, special: "N√© tr√°nh 25%" },
            'Nh·ªán ƒê·ªôc üï∑Ô∏è': { hp: 19, atk: 18, def: 0, exp: 17, dropCoin: { min: 9, max: 18 }, special: "ATK r·∫•t cao" },
            'C√¢y ƒÇn Th·ªãt Mini üåø': { hp: 38, atk: 7, def: 5, exp: 15, dropCoin: { min: 8, max: 17 }, special: "H√∫t m√°u" },
            'R·ªìng Nh·ªè L·∫°c ƒê∆∞·ªùng üêâ': { hp: 45, atk: 10, def: 10, exp: 20, dropCoin: { min: 10, max: 20 }, special: "R·∫•t hi·∫øm, EXP cao" },
            'Ma Qu√°i Y·∫øu üëª': { hp: 10, atk: 15, def: 0, exp: 10, dropCoin: { min: 1, max: 5 }, special: "D·ªÖ gi·∫øt, n√© tr√°nh cao" },
            'Th·ªè R·ª´ng Hung H√£n üêá': { hp: 23, atk: 12, def: 2, exp: 11, dropCoin: { min: 5, max: 10 }, special: "T·∫•n c√¥ng hai l·∫ßn" },
            'C√°o SƒÉn M·ªìi ü¶ä': { hp: 29, atk: 14, def: 0, exp: 13, dropCoin: { min: 6, max: 12 }, special: "ƒê√≤n ƒë√°nh l·ª´a" }
        };

        // --- D·ªÆ LI·ªÜU MINI BOSS (10 LO·∫†I) ---
        // S√°t th∆∞∆°ng, HP v√† EXP cao h∆°n qu√°i th∆∞·ªùng
        const MINI_BOSS_POOL = {
            'Kurisuzumugi ü¶Ä': { 
                hp: 120, atk: 25, def: 10, exp: 50, item: 'Ki·∫øm S√°ng', location: 'East Field', 
                special: "T·∫•n c√¥ng m·∫°nh, ph√≤ng th·ªß ·ªïn.", icon: 'ü¶Ä', dropCoin: { min: 30, max: 50 }
            },
            'N·∫•m Kh·ªïng L·ªì üçÑ': { 
                hp: 160, atk: 15, def: 5, exp: 40, item: 'N·∫•m H·ªìi Ph·ª•c', location: 'Forest', 
                special: "HP cao, c√≥ 25% l√†m Chiikawa 'Ch·∫≠m Ch·∫°p' (gi·∫£m ATK 50% trong 2 l∆∞·ª£t).", icon: 'üçÑ', dropCoin: { min: 25, max: 45 }
            },
            'Chu·ªôt Ch≈©i ƒêi√™n üêπ': { 
                hp: 80, atk: 30, def: 0, exp: 60, item: 'ƒê√° L·ª≠a', location: 'Cave', 
                special: "ATK cao, c√≥ 30% n√© tr√°nh ƒë√≤n ƒë√°nh c·ªßa Chiikawa.", icon: 'üêπ', evasion: 0.3, dropCoin: { min: 35, max: 55 }
            },
            'Nh√≠m Bi·ªÉn Gai üåä': { 
                hp: 100, atk: 18, def: 15, exp: 45, item: 'V·ªè Gai', location: 'Ocean', 
                special: "Ph·∫£n l·∫°i 10% s√°t th∆∞∆°ng nh·∫≠n ƒë∆∞·ª£c.", icon: 'üåä', reflect: 0.1, dropCoin: { min: 20, max: 40 }
            },
            'Ngao Kh·ªïng L·ªì üêö': { 
                hp: 250, atk: 5, def: 20, exp: 30, item: 'Ng·ªçc Trai', location: 'Deep Sea', 
                special: "HP v√† DEF c·ª±c cao, nh∆∞ng ƒë√°nh b·∫°i s·∫Ω r∆°i ra üí∞ 50-100 Chicoin.", icon: 'üêö', dropCoin: { min: 50, max: 100 }
            },
            'B√≤ S√°t ƒê·ªôc ü¶ñ': { 
                hp: 130, atk: 20, def: 8, exp: 55, item: 'Thu·ªëc Gi·∫£i ƒê·ªôc', location: 'Swamp', 
                special: "30% g√¢y hi·ªáu ·ª©ng 'ƒê·ªôc' (m·∫•t 5 HP m·ªói l∆∞·ª£t).", icon: 'ü¶ñ', poison: 0.3, dropCoin: { min: 40, max: 60 }
            },
            'Chim Kh·ªïng L·ªì ü¶Ö': { 
                hp: 90, atk: 35, def: 5, exp: 70, item: 'L√¥ng V≈© T·ªëc ƒê·ªô', location: 'Mountain', 
                special: "ATK c·ª±c cao, nh∆∞ng HP th·∫•p. C√≥ 20% t·∫•n c√¥ng hai l·∫ßn.", icon: 'ü¶Ö', doubleAttack: 0.2, dropCoin: { min: 50, max: 70 }
            },
            'Ng∆∞·ªùi ƒê√° üóø': { 
                hp: 200, atk: 10, def: 30, exp: 40, item: 'Gi√°p ƒê√°', location: 'Volcano', 
                special: "DEF r·∫•t cao, nh∆∞ng d·ªÖ b·ªã t·∫•n c√¥ng ph√©p (hi·ªán kh√¥ng c√≥).", icon: 'üóø', dropCoin: { min: 30, max: 50 }
            },
            'H·ªìn Ma Qu·ª∑ Quy·ªát üòà': { 
                hp: 150, atk: 22, def: 0, exp: 65, item: 'B√πa Ma', location: 'Old House', 
                special: "T·∫•n c√¥ng b·ªè qua 50% DEF c·ªßa ng∆∞·ªùi ch∆°i.", icon: 'üòà', ignoreDef: 0.5, dropCoin: { min: 45, max: 65 }
            },
            'Heo R·ª´ng C∆°n Gi·∫≠n üêó': { 
                hp: 180, atk: 20, def: 15, exp: 50, item: 'Nanh S·∫Øc', location: 'Jungle', 
                special: "S√°t th∆∞∆°ng tƒÉng l√™n khi HP c·ªßa n√≥ d∆∞·ªõi 50%.", icon: 'üêó', rage: 0.5, dropCoin: { min: 35, max: 55 }
            }
        };

        // --- D·ªÆ LI·ªÜU BOSS CH√çNH (3 LO·∫†I) ---
        // S√°t th∆∞∆°ng, HP v√† EXP R·∫§T CAO
        const FINAL_BOSS_POOL = {
            'Si√™u S√¢u B∆∞·ªõm Kh·ªïng L·ªì ü¶ã': {
                hp: 400, atk: 40, def: 20, exp: 500, item: 'C√°nh B∆∞·ªõm Ph√©p', 
                special: "M·ªói 3 l∆∞·ª£t, n√≥ s·∫Ω h·ªìi 50 HP. C·∫ßn s√°t th∆∞∆°ng d·ªìn d·∫≠p.", icon: 'ü¶ã', dropCoin: { min: 150, max: 250 }, healTurn: 3, healAmount: 50
            },
            'Qu√°i V·∫≠t T√≠ Hon üëπ': {
                hp: 350, atk: 50, def: 10, exp: 600, item: 'S·ª´ng Qu·ª∑', 
                special: "ATK c·ª±c cao. C√≥ 50% g√¢y hi·ªáu ·ª©ng 'Cho√°ng' (ng∆∞·ªùi ch∆°i kh√¥ng th·ªÉ h√†nh ƒë·ªông l∆∞·ª£t sau).", icon: 'üëπ', dropCoin: { min: 200, max: 300 }, stunChance: 0.5
            },
            'Thi√™n Th·∫ßn Sa Ng√£ üòá': {
                hp: 500, atk: 30, def: 30, exp: 800, item: 'H√†o Quang V√¥ C·ª±c', 
                special: "HP v√† DEF r·∫•t cao. T·∫•n c√¥ng c√≥ 20% l√†m gi·∫£m DEF vƒ©nh vi·ªÖn c·ªßa ng∆∞·ªùi ch∆°i (-2 DEF).", icon: 'üòá', dropCoin: { min: 250, max: 350 }, defDebuff: 0.2
            }
        };

        // Bi·∫øn ƒë·ªÉ theo d√µi l∆∞·ª£t ƒë√°nh c·ªßa Boss ch√≠nh
        let bossTurnCount = 0;


        // --- D·ªÆ LI·ªÜU V≈® KH√ç ---
        const WEAPONS = {
            'Kh√¥ng': { atk: 0, def: 0 },
            'G·∫≠y G·ªó': { atk: 5, def: 0 },
            'Ki·∫øm S√°ng': { atk: 10, def: 2 },
            'Ki·∫øm S·∫Øt ‚öîÔ∏è': { atk: 8, def: 0 },
            'Cung G·ªó üèπ': { atk: 5, def: 5 },
            // V≈© kh√≠ t·ª´ Boss
            'C√°nh B∆∞·ªõm Ph√©p': { atk: 15, def: 5 },
            'S·ª´ng Qu·ª∑': { atk: 20, def: 0 },
            'H√†o Quang V√¥ C·ª±c': { atk: 10, def: 15 }
        };

        // --- D·ªÆ LI·ªÜU SHOP ---
        const FOOD_ITEMS = {
            'C√† Ph√™ ‚òï': { price: 15, heal: 20, description: "+20 HP (Nh·ªè)" },
            'M√¨ Ly üçú': { price: 30, heal: 50, description: "+50 HP (V·ª´a)" },
            'B√°nh C√° üêü': { price: 50, heal: 80, description: "+80 HP (L·ªõn)" }
        };

        const WEAPONS_SHOP = {
            'Ki·∫øm S·∫Øt ‚öîÔ∏è': { price: 150, atk: 8, def: 0, description: "ATK +8, C·∫£i thi·ªán t·ª´ G·∫≠y G·ªó" },
            'Cung G·ªó üèπ': { price: 100, atk: 5, def: 5, description: "ATK +5, DEF +5, C√¢n b·∫±ng" }
        };

        const CAKE_HEAL_AMOUNT = 30; // L∆∞·ª£ng h·ªìi m√°u c·ªßa b√°nh

        // C·ªët truy·ªán m·ªõi: L√Ω do ph·∫£i ƒë√°nh qu√°i
        const INITIAL_QUEST = {
            name: "Linh C·∫£m V·ªÅ C∆°n M∆∞a",
            description: "T·ª´ ng√†y c∆°n 'M∆∞a B√≠ ·∫®n' r∆°i xu·ªëng, c√°c qu√°i v·∫≠t th∆∞·ªùng tr·ªü n√™n hung d·ªØ v√† c·∫£n tr·ªü vi·ªác sƒÉn l√πng Chicoin. Hachiware c·∫ßn t√¨m m·ªôt chi·∫øc G·∫≠y G·ªó ƒë·ªÉ t·ª± v·ªá trong khi ƒëi·ªÅu tra. H√£y chi·∫øn ƒë·∫•u v·ªõi 5 con Qu√°i Th∆∞·ªùng b·∫•t k·ª≥ ƒë·ªÉ t√¨m n√≥.",
            target: 'Qu√°i Th∆∞·ªùng',
            requiredCount: 5,
            currentCount: 0,
            reward: { item: 'G·∫≠y G·ªó' },
            active: true
        };
        
        // --- H·ªÜ TH·ªêNG √ÇM THANH (TONE.JS) ---
        let backgroundMusic = null;
        let isMusicPlaying = false;
        const MUSIC_URL = "http://googleusercontent.com/file_content/2"; 

        function setupMusic() {
            if (backgroundMusic) return;

            backgroundMusic = new Tone.Player({
                url: MUSIC_URL,
                loop: true, 
                autostart: false,
                volume: -10, 
                onerror: (e) => {
                    const musicBtn = document.getElementById('musicBtn');
                    musicBtn.textContent = '‚ùå L·ªói Nh·∫°c (Vui l√≤ng b√°o l·∫°i)';
                    musicBtn.disabled = true;
                    isMusicPlaying = false;
                    logMessage(`L·ªñI: Kh√¥ng th·ªÉ t·∫£i file nh·∫°c 'chiiik.mp3'. T·ªáp c√≥ th·ªÉ b·ªã h·ªèng ho·∫∑c ƒë·ªãnh d·∫°ng kh√¥ng t∆∞∆°ng th√≠ch.`, 'error');
                    console.error("Tone.js Load Error:", e);
                }
            }).toDestination();
        }

        function toggleMusic() {
            setupMusic(); 

            Tone.start().then(() => {
                if (isMusicPlaying) {
                    backgroundMusic.stop();
                    isMusicPlaying = false;
                    document.getElementById('musicBtn').textContent = 'üîá B·∫≠t Nh·∫°c';
                    logMessage("ƒê√£ t·∫Øt nh·∫°c n·ªÅn.", 'info');
                } else {
                    const musicBtn = document.createElement('button');
                    musicBtn.onclick = toggleMusic;
                    musicBtn.id = 'musicBtn';
                    musicBtn.textContent = 'üé∂ ƒêang T·∫£i Nh·∫°c...';
                    musicBtn.disabled = true; 
                    document.getElementById('musicBtn').remove();
                    document.getElementById('gameControls').prepend(musicBtn);
                    logMessage("ƒêang t·∫£i nh·∫°c 'chiiik.mp3', vui l√≤ng ch·ªù...", 'info');
                    
                    backgroundMusic.load(MUSIC_URL).then(() => {
                        backgroundMusic.start(0);
                        isMusicPlaying = true;
                        document.getElementById('musicBtn').textContent = 'üîä T·∫Øt Nh·∫°c';
                        document.getElementById('musicBtn').disabled = false;
                        logMessage("ƒê√£ t·∫£i xong v√† b·∫≠t nh·∫°c n·ªÅn!", 'info');
                    }).catch(e => {
                        document.getElementById('musicBtn').textContent = '‚ùå L·ªói Nh·∫°c (Th·∫•t b·∫°i)';
                        document.getElementById('musicBtn').disabled = true;
                        isMusicPlaying = false;
                        logMessage("L·ªñI L·ªöN: Kh√¥ng th·ªÉ t·∫£i file nh·∫°c MP3. Vui l√≤ng ki·ªÉm tra file.", 'error');
                        console.error("Tone.js Load Error (Promise):", e);
                    });
                }
            }).catch(e => {
                logMessage("L·ªói khi kh·ªüi ƒë·ªông √¢m thanh (c·∫ßn t∆∞∆°ng t√°c ng∆∞·ªùi d√πng).", 'error');
                console.error("Tone.start Error:", e);
            });
        }


        // --- L∆ØU TR·ªÆ (FIREBASE / LOCAL) ---

        async function saveGame() {
            if (!window.userId) {
                document.getElementById('saveLoadStatus').textContent = "Kh√¥ng th·ªÉ l∆∞u: ƒêang ch·ªù Auth.";
                return;
            }
            if (!game || !game.player || !game.player.name) {
                document.getElementById('saveLoadStatus').textContent = "Kh√¥ng th·ªÉ l∆∞u: Ch∆∞a ch·ªçn nh√¢n v·∫≠t.";
                return;
            }

            // ƒê·∫£m b·∫£o kh√¥ng l∆∞u object enemy ƒëang chi·∫øn ƒë·∫•u
            const gameData = {
                player: game.player,
                quest: game.quest,
                location: game.location,
                bossDefeated: game.bossDefeated,
                finalBossesDefeated: game.finalBossesDefeated || [], // L∆∞u tr·∫°ng th√°i boss ch√≠nh
                playerStatusEffects: game.playerStatusEffects || { slowed: 0, focused: false, defending: false, stunned: 0, poisoned: 0 }, 
                timestamp: new Date().toISOString()
            };

            const docRef = doc(window.db, "artifacts", appId, "users", window.userId, GAME_DATA_COLLECTION, "gameState");

            try {
                await setDoc(docRef, gameData);
                document.getElementById('saveLoadStatus').textContent = "ƒê√£ l∆∞u game th√†nh c√¥ng! " + new Date().toLocaleTimeString('vi-VN');
            } catch (error) {
                console.error("L·ªói khi l∆∞u game:", error);
                document.getElementById('saveLoadStatus').textContent = "L∆ØU TH·∫§T B·∫†I. Xem console log.";
            }
        }

        async function loadGame() {
            if (!window.userId) return;
            document.getElementById('displayUserId').textContent = window.userId.substring(0, 8) + '...';

            const docRef = doc(window.db, "artifacts", appId, "users", window.userId, GAME_DATA_COLLECTION, "gameState");

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    game = loadedData;
                    if (game && game.player) {
                        // ƒê·∫£m b·∫£o c√°c thu·ªôc t√≠nh c≈©/m·ªõi t·ªìn t·∫°i
                        if (game.bossDefeated === undefined) game.bossDefeated = false;
                        if (game.finalBossesDefeated === undefined) game.finalBossesDefeated = [];
                        if (game.player.chicoin === undefined) game.player.chicoin = 0; 
                        if (!game.player.inventory) game.player.inventory = {};
                        
                        // Kh·ªüi t·∫°o/c·∫≠p nh·∫≠t hi·ªáu ·ª©ng chi·∫øn thu·∫≠t m·ªõi
                        if (!game.playerStatusEffects) {
                             game.playerStatusEffects = { slowed: 0, focused: false, defending: false, stunned: 0, poisoned: 0 }; 
                        } else {
                            if (game.playerStatusEffects.focused === undefined) game.playerStatusEffects.focused = false;
                            if (game.playerStatusEffects.defending === undefined) game.playerStatusEffects.defending = false;
                            if (game.playerStatusEffects.stunned === undefined) game.playerStatusEffects.stunned = 0;
                            if (game.playerStatusEffects.poisoned === undefined) game.playerStatusEffects.poisoned = 0;
                        }
                        
                        // Th√™m v·∫≠t ph·∫©m m·ªõi n·∫øu ch∆∞a c√≥
                        if (game.player.inventory['B√°nh B√¥ng Lan üç∞'] === undefined) {
                            game.player.inventory['B√°nh B√¥ng Lan üç∞'] = 3; 
                        }
                        
                        startGame(game.player.name, false);
                        document.getElementById('saveLoadStatus').textContent = "ƒê√£ t·∫£i game th√†nh c√¥ng! " + new Date().toLocaleTimeString('vi-VN');
                        logMessage(`Ch√†o m·ª´ng tr·ªü l·∫°i, ${game.player.name}!`, 'info');
                        updateControls();
                        return true;
                    }
                }
                document.getElementById('saveLoadStatus').textContent = "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu game ƒë√£ l∆∞u.";
                return false;
            } catch (error) {
                console.error("L·ªói khi t·∫£i game:", error);
                document.getElementById('saveLoadStatus').textContent = "T·∫¢I TH·∫§T B·∫†I. Xem console log.";
                return false;
            }
        }

        window.onFirebaseReady = async () => {
            document.getElementById('saveLoadStatus').textContent = "ƒê√£ k·∫øt n·ªëi Firebase.";
            await loadGame();
        };

        // --- H·ªÜ TH·ªêNG GAMEPLAY ---

        function initGame(charName) {
            const base = BASE_STATS[charName];
            const player = {
                name: charName,
                icon: base.icon,
                level: 1,
                hp: base.hp,
                maxHp: base.hp,
                atk: base.atk,
                def: base.def,
                exp: 0,
                nextLevelExp: 100,
                chicoin: 50, 
                weapon: 'Kh√¥ng',
                inventory: {
                    'G·∫≠y G·ªó': 0,
                    'Ki·∫øm S√°ng': 0,
                    'ƒê√° May M·∫Øn': 0,
                    'N·∫•m H·ªìi Ph·ª•c': 0,
                    'V·ªè Gai': 0,
                    'Ng·ªçc Trai': 0,
                    'ƒê√° L·ª≠a': 0,
                    'Thu·ªëc Gi·∫£i ƒê·ªôc': 0,
                    'L√¥ng V≈© T·ªëc ƒê·ªô': 0,
                    'Gi√°p ƒê√°': 0,
                    'B√πa Ma': 0,
                    'Nanh S·∫Øc': 0,
                    'C√°nh B∆∞·ªõm Ph√©p': 0,
                    'S·ª´ng Qu·ª∑': 0,
                    'H√†o Quang V√¥ C·ª±c': 0,
                    'B√°nh B√¥ng Lan üç∞': 3 
                }
            };

            game = {
                player: player,
                quest: INITIAL_QUEST,
                location: 'Home',
                bossDefeated: false,
                finalBossesDefeated: [],
                playerStatusEffects: {
                    slowed: 0, // S·ªë l∆∞·ª£t c√≤n l·∫°i b·ªã ch·∫≠m ch·∫°p
                    focused: false, // T·∫≠p trung cho l∆∞·ª£t ƒë√°nh ti·∫øp theo
                    defending: false, // ƒêang ph√≤ng th·ªß cho l∆∞·ª£t qu√°i ƒë√°nh ti·∫øp theo
                    stunned: 0, // B·ªã cho√°ng (kh√¥ng h√†nh ƒë·ªông ƒë∆∞·ª£c)
                    poisoned: 0 // B·ªã tr√∫ng ƒë·ªôc (m·∫•t HP m·ªói l∆∞·ª£t)
                }
            };
        }

        function startGame(charName, isNewGame = true) {
            if (isNewGame) {
                initGame(charName);
                logMessage(`B·∫°n ƒë√£ ch·ªçn ${charName}. B·∫Øt ƒë·∫ßu cu·ªôc phi√™u l∆∞u!`, 'info');
                // Th√™m c·ªët truy·ªán m·ªõi
                logMessage(`üí¶ M·ªôt c∆°n 'M∆∞a B√≠ ·∫®n' ƒë√£ khi·∫øn c√°c qu√°i v·∫≠t tr·ªü n√™n hung hƒÉng v√† c·∫£n tr·ªü vi·ªác sƒÉn l√πng Chicoin!`, 'message-error');
                logMessage(`üí∞ B·∫°n nh·∫≠n ƒë∆∞·ª£c üí∞ ${game.player.chicoin} Chicoin kh·ªüi ƒë·∫ßu!`, 'message-coin');
                logMessage(`Nhi·ªám v·ª• ƒë·∫ßu ti√™n: ${game.quest.description}`, 'quest');
            }

            // Chuy·ªÉn sang m√†n h√¨nh ch√≠nh
            switchView('main');
            updateUI();
            updateControls();
            saveGame(); // L∆∞u game ngay khi b·∫Øt ƒë·∫ßu/t·∫£i
        }
        
        function switchView(viewName) {
            currentView = viewName;
            document.getElementById('charSelection').style.display = 'none';
            document.getElementById('mainGameView').style.display = 'none';
            document.getElementById('shopView').style.display = 'none';
            document.getElementById('finalBossView').style.display = 'none';
            document.getElementById('enemy-status').style.display = 'none'; // ·∫®n tr·∫°ng th√°i ƒë·ªãch

            if (viewName === 'selection') {
                 document.getElementById('charSelection').style.display = 'block';
                 document.getElementById('currencyDisplay').style.display = 'none';
            } else if (viewName === 'main') {
                document.getElementById('mainGameView').style.display = 'block';
                document.getElementById('currencyDisplay').style.display = 'flex';
            } else if (viewName === 'shop') {
                document.getElementById('shopView').style.display = 'block';
                document.getElementById('currencyDisplay').style.display = 'flex';
                renderShop(); // T·∫£i n·ªôi dung c·ª≠a h√†ng
            } else if (viewName === 'finalBoss') {
                document.getElementById('finalBossView').style.display = 'block';
                document.getElementById('currencyDisplay').style.display = 'flex';
                renderFinalBosses();
            }
            updateControls();
        }

        function selectCharacter(charName) {
            // T·∫Øt/B·∫≠t m√†u cho th·∫ª ƒë√£ ch·ªçn
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.character-card[data-char="${charName}"]`).classList.add('selected');

            // B·∫Øt ƒë·∫ßu game
            startGame(charName, true);
        }

        function updateUI() {
            if (!game || !game.player) return;

            const p = game.player;
            // X·ª≠ l√Ω v≈© kh√≠ 
            const w = WEAPONS[p.weapon] || WEAPONS['Kh√¥ng'];
            let totalAtk = p.atk + w.atk;
            let totalDef = p.def + w.def;

            // X·ª≠ l√Ω hi·ªáu ·ª©ng tr·∫°ng th√°i
            let statusText = 'Kh·ªèe m·∫°nh';
            
            // Gi·∫£m ATK 50% khi Slowed
            if (game.playerStatusEffects.slowed > 0) {
                totalAtk = Math.floor(totalAtk * 0.5); 
                statusText = `Ch·∫≠m Ch·∫°p (-50% ATK, ${game.playerStatusEffects.slowed} l∆∞·ª£t)`;
            }
            // Kh√¥ng h√†nh ƒë·ªông ƒë∆∞·ª£c khi Stunned
            if (game.playerStatusEffects.stunned > 0) {
                 statusText += (statusText === 'Kh·ªèe m·∫°nh' ? '' : ', ') + `Cho√°ng (Kh√¥ng h√†nh ƒë·ªông, ${game.playerStatusEffects.stunned} l∆∞·ª£t)`;
            }
            // S√°t th∆∞∆°ng ƒë·ªôc
            if (game.playerStatusEffects.poisoned > 0) {
                 statusText += (statusText === 'Kh·ªèe m·∫°nh' ? '' : ', ') + `Tr√∫ng ƒê·ªôc (-5 HP/l∆∞·ª£t, ${game.playerStatusEffects.poisoned} l∆∞·ª£t)`;
            }

            if (game.playerStatusEffects.focused) {
                statusText += (statusText === 'Kh·ªèe m·∫°nh' ? '' : ', ') + 'T·∫≠p Trung (+50% ATK)';
            }
            if (game.playerStatusEffects.defending) {
                statusText += (statusText === 'Kh·ªèe m·∫°nh' ? '' : ', ') + 'Ph√≤ng Th·ªß (+100% DEF)';
            }
            
            if (statusText === 'Kh·ªèe m·∫°nh') {
                 document.getElementById('player-effects').style.color = 'green';
                 statusText = 'Kh√¥ng';
            } else {
                 document.getElementById('player-effects').style.color = '#008888';
            }


            document.getElementById('player-name').textContent = `${p.icon} ${p.name}`;
            document.getElementById('player-level').textContent = p.level;
            document.getElementById('player-hp').textContent = `${p.hp}/${p.maxHp}`;
            document.getElementById('player-atk').textContent = `${totalAtk} (${p.atk} + ${w.atk})`;
            document.getElementById('player-def').textContent = `${totalDef} (${p.def} + ${w.def})`;
            document.getElementById('player-exp').textContent = `${p.exp}/${p.nextLevelExp}`;
            document.getElementById('player-weapon').textContent = p.weapon;
            document.getElementById('player-chicoin').textContent = p.chicoin.toLocaleString('vi-VN'); 
            document.getElementById('player-effects').textContent = statusText;

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i Enemy
            const enemyStatusDiv = document.getElementById('enemy-status');
            if (isInFight && currentEnemy) {
                enemyStatusDiv.style.display = 'block';
                const enemyType = currentEnemy.isBoss 
                    ? currentEnemy.isFinalBoss ? 'Boss' : 'Mini Boss'
                    : 'Qu√°i Th∆∞·ªùng';
                
                document.getElementById('enemy-name-display').textContent = `K·∫ª Th√π (${enemyType}): ${currentEnemy.icon} ${currentEnemy.name.split(' ')[0]}`;
                document.getElementById('enemy-hp-display').textContent = `HP: ${Math.max(0, currentEnemy.hp)}/${currentEnemy.maxHp}`;
            } else {
                enemyStatusDiv.style.display = 'none';
            }

            // C·∫≠p nh·∫≠t Inventory
            const invDiv = document.getElementById('player-inventory');
            invDiv.innerHTML = '';
            for (const item in p.inventory) {
                // Ch·ªâ hi·ªÉn th·ªã v·∫≠t ph·∫©m c√≥ s·ªë l∆∞·ª£ng > 0
                if (p.inventory[item] > 0) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    itemDiv.textContent = `${item} (x${p.inventory[item]})`;
                    invDiv.appendChild(itemDiv);
                }
            }
        }

        function updateControls() {
            const controlsDiv = document.getElementById('gameControls');
            controlsDiv.innerHTML = '';

            // Lu√¥n c√≥ n√∫t Nh·∫°c
            const musicButton = document.createElement('button');
            musicButton.onclick = toggleMusic;
            musicButton.id = 'musicBtn';
            musicButton.textContent = isMusicPlaying ? 'üîä T·∫Øt Nh·∫°c' : 'üîá B·∫≠t Nh·∫°c';
            controlsDiv.appendChild(musicButton);
            
            // N·∫øu ƒëang ·ªü m√†n h√¨nh Shop ho·∫∑c Boss Ch√≠nh, ch·ªâ hi·ªÉn th·ªã n√∫t Back
            if (currentView === 'shop' || currentView === 'finalBoss') {
                const backBtn = document.createElement('button');
                backBtn.textContent = '‚óÄÔ∏è Tr·ªü v·ªÅ Game';
                backBtn.onclick = () => switchView('main');
                backBtn.style.backgroundColor = 'var(--hachiware-blue)';
                controlsDiv.appendChild(backBtn);
                return; 
            }

            // N·∫øu ƒëang ·ªü m√†n h√¨nh ch√≠nh
            if (currentView === 'main') {
                
                // --- KHI ƒêANG TRONG TR·∫¨N ƒê·∫§U (Turn-based) ---
                if (isInFight && currentEnemy && game.player.hp > 0) {
                    // Khu v·ª±c h√†nh ƒë·ªông chi·∫øn ƒë·∫•u
                    const combatActionsDiv = document.createElement('div');
                    combatActionsDiv.className = 'combat-actions';
                    
                    const enemyName = currentEnemy.icon + ' ' + currentEnemy.name.split(' ')[0];
                    
                    // N√∫t T·∫§N C√îNG
                    const attackBtn = document.createElement('button');
                    attackBtn.textContent = `‚öîÔ∏è T·∫§N C√îNG ${enemyName} (L∆∞·ª£t)`;
                    // V√¥ hi·ªáu h√≥a khi b·ªã cho√°ng
                    attackBtn.disabled = game.playerStatusEffects.stunned > 0;
                    if (game.playerStatusEffects.stunned > 0) {
                        attackBtn.textContent = `üòµ Cho√°ng (${game.playerStatusEffects.stunned} l∆∞·ª£t)`;
                    }

                    attackBtn.onclick = () => takeTurn('attack'); 
                    attackBtn.className = 'attack-btn';
                    combatActionsDiv.appendChild(attackBtn);

                    // 2. N√∫t T·∫¨P TRUNG (Focus)
                    const focusBtn = document.createElement('button');
                    focusBtn.textContent = 'üéØ T·∫¨P TRUNG (+50% ATK)';
                    focusBtn.disabled = game.playerStatusEffects.focused || game.playerStatusEffects.defending || game.playerStatusEffects.stunned > 0;
                    focusBtn.onclick = () => takeTurn('focus');
                    combatActionsDiv.appendChild(focusBtn);
                    
                    // 3. N√∫t PH√íNG TH·ª¶ (Defend)
                    const defendBtn = document.createElement('button');
                    defendBtn.textContent = 'üõ°Ô∏è PH√íNG TH·ª¶ (+100% DEF)';
                    defendBtn.disabled = game.playerStatusEffects.focused || game.playerStatusEffects.defending || game.playerStatusEffects.stunned > 0;
                    defendBtn.onclick = () => takeTurn('defend');
                    combatActionsDiv.appendChild(defendBtn);
                    
                    // 4. N√∫t ƒÇn B√ÅNH/FOOD 
                    const cakeCount = game.player.inventory['B√°nh B√¥ng Lan üç∞'] || 0;
                    if (cakeCount > 0) {
                        const eatCakeBtn = document.createElement('button');
                        eatCakeBtn.textContent = `üç∞ ƒÇn B√°nh (x${cakeCount})`;
                        eatCakeBtn.disabled = cakeUsedInFight;
                        eatCakeBtn.onclick = eatCake;
                        eatCakeBtn.style.backgroundColor = '#fca5a5';
                        combatActionsDiv.appendChild(eatCakeBtn);
                    }
                    
                    controlsDiv.appendChild(combatActionsDiv);
                    
                    return; 
                }
                // --- KHI ·ªû NGO√ÄI TR·∫¨N ƒê·∫§U ---

                // N√∫t C·ª≠a H√†ng
                const shopBtn = document.createElement('button');
                shopBtn.textContent = 'üõçÔ∏è C·ª≠a H√†ng';
                shopBtn.onclick = () => switchView('shop');
                shopBtn.style.backgroundColor = 'var(--usagi-yellow)';
                controlsDiv.appendChild(shopBtn);
                
                // N√∫t Ngh·ªâ ng∆°i (H·ªìi m√°u - ch·ªâ hi·ªÉn th·ªã ngo√†i tr·∫≠n)
                if (game.player.hp < game.player.maxHp || game.playerStatusEffects.poisoned > 0) {
                    const restBtn = document.createElement('button');
                    restBtn.textContent = 'üè† Ngh·ªâ Ng∆°i (H·ªìi HP & Gi·∫£i ƒê·ªôc)';
                    restBtn.onclick = rest;
                    controlsDiv.appendChild(restBtn);
                }

                // N√∫t Trang b·ªã (n·∫øu c√≥ v≈© kh√≠)
                for (const item in WEAPONS) {
                    if (item !== 'Kh√¥ng' && game.player.inventory[item] > 0 && item !== game.player.weapon) {
                        const equipBtn = document.createElement('button');
                        equipBtn.textContent = `‚öîÔ∏è Trang b·ªã ${item.replace('‚öîÔ∏è', '').trim()}`;
                        equipBtn.onclick = () => equipWeapon(item);
                        controlsDiv.appendChild(equipBtn);
                    }
                }

                // N√∫t H√†nh ƒë·ªông ch√≠nh (N√öT ƒê√ÅNH)
                if (game.quest.active) {
                    const questBtn = document.createElement('button');
                    questBtn.textContent = `üîç Nhi·ªám v·ª•: ${game.quest.currentCount}/${game.quest.requiredCount} Qu√°i`;
                    questBtn.onclick = startQuestFight;
                    questBtn.style.backgroundColor = '#bbf7d0'; 
                    controlsDiv.appendChild(questBtn);
                } else {
                    // ƒê√°nh Mini-Boss ng·∫´u nhi√™n
                    const bossBtn = document.createElement('button');
                    bossBtn.textContent = `‚öîÔ∏è Kh√°m ph√° & Chi·∫øn ƒë·∫•u Mini Boss!`;
                    bossBtn.onclick = startRandomBossFight;
                    bossBtn.style.backgroundColor = '#fca5a5'; 
                    controlsDiv.appendChild(bossBtn);
                    
                    // Boss Ch√≠nh
                    const finalBossBtn = document.createElement('button');
                    finalBossBtn.textContent = `üî• Th·ª≠ Th√°ch Boss Ch√≠nh`;
                    finalBossBtn.onclick = () => switchView('finalBoss');
                    finalBossBtn.style.backgroundColor = '#9333ea'; 
                    finalBossBtn.style.color = 'white';
                    controlsDiv.appendChild(finalBossBtn);
                }

                // N√∫t L∆∞u game th·ªß c√¥ng 
                const manualSaveBtn = document.createElement('button');
                manualSaveBtn.textContent = 'üíæ L∆∞u Game';
                manualSaveBtn.onclick = saveGame;
                controlsDiv.appendChild(manualSaveBtn);
            }
        }

        function logMessage(message, type = 'normal') {
            const logArea = document.getElementById('gameLog');
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString('vi-VN')}] ${message}`;
            p.className = `message-${type}`;
            logArea.prepend(p);
            // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng log
            while (logArea.children.length > 50) {
                logArea.removeChild(logArea.lastChild);
            }
        }

        function equipWeapon(weaponName) {
            // ƒê·∫£m b·∫£o ch·ªâ s·ªë l∆∞·ª£ng l·ªõn h∆°n 0 m·ªõi trang b·ªã ƒë∆∞·ª£c
            if ((game.player.inventory[weaponName] > 0 || weaponName === 'Kh√¥ng') && WEAPONS[weaponName]) {
                const oldWeapon = game.player.weapon;
                game.player.weapon = weaponName;
                const newAtk = WEAPONS[weaponName].atk;
                logMessage(`${game.player.name} ƒë√£ trang b·ªã ${weaponName}. (ATK +${newAtk})`, 'info');
                updateUI();
                updateControls();
                saveGame();
            } else {
                logMessage(`Kh√¥ng th·ªÉ trang b·ªã ${weaponName}.`, 'error');
            }
        }

        function rest() {
            if (game.player.hp === game.player.maxHp && game.playerStatusEffects.poisoned === 0) {
                logMessage(`${game.player.name} ƒë√£ kh·ªèe m·∫°nh v√† kh√¥ng b·ªã tr√∫ng ƒë·ªôc!`, 'info');
                return;
            }
            
            const healAmount = Math.floor(game.player.maxHp * 0.5);
            game.player.hp = Math.min(game.player.hp + healAmount, game.player.maxHp);
            logMessage(`ƒê√£ ngh·ªâ ng∆°i v√† h·ªìi ${healAmount} HP. HP hi·ªán t·∫°i: ${game.player.hp}/${game.player.maxHp}`, 'info');

            // Gi·∫£i ƒë·ªôc
            if (game.playerStatusEffects.poisoned > 0) {
                game.playerStatusEffects.poisoned = 0;
                logMessage(`üçµ ƒê√£ gi·∫£i ƒë·ªôc th√†nh c√¥ng!`, 'message-info');
            }
            
            updateUI();
            saveGame();
        }

        function useConsumable(itemName, healAmount) {
            const p = game.player;
            if (p.inventory[itemName] <= 0) {
                logMessage(`B·∫°n kh√¥ng c√≤n ${itemName} n√†o!`, 'error');
                return false;
            }
            if (p.hp === p.maxHp) {
                 logMessage("HP ƒë√£ ƒë·∫ßy, kh√¥ng c·∫ßn d√πng v·∫≠t ph·∫©m h·ªìi m√°u!", 'warn');
                 return false;
            }

            // S·ª≠ d·ª•ng item
            p.inventory[itemName]--;
            
            p.hp = Math.min(p.hp + healAmount, p.maxHp);
            
            logMessage(`‚ú® ${p.name} d√πng ${itemName} v√† h·ªìi ${healAmount} HP! HP hi·ªán t·∫°i: ${p.hp}/${p.maxHp}`, 'message-info');
            
            updateUI();
            updateControls(); 
            saveGame();
            return true;
        }

        function eatCake() {
            if (!isInFight) {
                logMessage("B·∫°n ch·ªâ c√≥ th·ªÉ ƒÉn b√°nh khi ƒëang trong tr·∫≠n chi·∫øn!", 'warn');
                return;
            }
            if (cakeUsedInFight) {
                logMessage("B·∫°n ƒë√£ s·ª≠ d·ª•ng B√°nh B√¥ng Lan trong tr·∫≠n n√†y r·ªìi!", 'warn');
                return;
            }
            if (useConsumable('B√°nh B√¥ng Lan üç∞', CAKE_HEAL_AMOUNT)) {
                 cakeUsedInFight = true; // Ch·ªâ ƒë√°nh d·∫•u ƒë√£ d√πng n·∫øu vi·ªác h·ªìi m√°u th√†nh c√¥ng
                 updateControls(); 
            }
        }


        function gainExp(exp) {
            game.player.exp += exp;
            logMessage(`+${exp} EXP!`, 'info');

            while (game.player.exp >= game.player.nextLevelExp) {
                levelUp();
            }
            updateUI();
            saveGame();
        }
        
        function gainChicoin(amount) {
             game.player.chicoin += amount;
             logMessage(`+üí∞ ${amount} Chicoin!`, 'message-coin');
             updateUI();
             saveGame();
        }

        function levelUp() {
            const p = game.player;
            p.level++;
            p.exp -= p.nextLevelExp; // Gi·ªØ l·∫°i EXP th·ª´a
            p.nextLevelExp = Math.floor(p.nextLevelExp * 1.5); // TƒÉng EXP y√™u c·∫ßu
            p.maxHp += 15;
            p.hp = p.maxHp; // H·ªìi ƒë·∫ßy m√°u
            p.atk += 3;
            p.def += 2;
            logMessage(`üéâ CH√öC M·ª™NG! ${p.name} ƒë√£ thƒÉng l√™n C·∫•p ${p.level}!`, 'message-quest');
            logMessage(`HP +15, ATK +3, DEF +2.`, 'message-quest');
        }

        function lootItem(item) {
            if (game.player.inventory[item] !== undefined) {
                game.player.inventory[item]++;
                logMessage(`T√¨m th·∫•y 1x ${item} trong r∆∞∆°ng!`, 'info');
            } else {
                // T·∫°o item m·ªõi n·∫øu ch∆∞a c√≥
                game.player.inventory[item] = 1;
                logMessage(`Nh·∫≠n ƒë∆∞·ª£c V·∫≠t ph·∫©m ƒë·∫∑c bi·ªát: ${item}!`, 'info');
            }
        }

        // --- C√ÅC HO·∫†T ƒê·ªòNG CHI·∫æN ƒê·∫§U ---

        function calculateDamage(attacker, defender, isPlayer = false) {
            // L·∫•y ch·ªâ s·ªë ATK c·ªßa ng∆∞·ªùi t·∫•n c√¥ng (c√≥ t√≠nh v≈© kh√≠)
            const attackerWeapon = attacker.weapon || 'Kh√¥ng'; 
            let attackerAtk = attacker.atk + (WEAPONS[attackerWeapon] ? WEAPONS[attackerWeapon].atk : 0);
            
            // L·∫•y ch·ªâ s·ªë DEF c·ªßa ng∆∞·ªùi ph√≤ng th·ªß (c√≥ t√≠nh v≈© kh√≠)
            const defenderWeapon = defender.weapon || 'Kh√¥ng';
            let defenderDef = defender.def + (WEAPONS[defenderWeapon] ? WEAPONS[defenderWeapon].def : 0);
            
            // --- X·ª≠ l√Ω hi·ªáu ·ª©ng T·∫•n c√¥ng c·ªßa Player ---
            if (isPlayer) {
                // Ch·∫≠m Ch·∫°p
                if (game.playerStatusEffects.slowed > 0) {
                     attackerAtk = Math.floor(attackerAtk * 0.5);
                }
                // T·∫≠p Trung
                if (game.playerStatusEffects.focused) {
                    attackerAtk = Math.floor(attackerAtk * COMBAT_EFFECTS.FOCUS_DAMAGE_MULTIPLIER);
                }
            }
            
            // --- X·ª≠ l√Ω hi·ªáu ·ª©ng Ph√≤ng th·ªß c·ªßa Player ---
            if (!isPlayer) { // Qu√°i t·∫•n c√¥ng, Player l√† defender
                // Ph√≤ng Th·ªß
                if (game.playerStatusEffects.defending) { 
                    defenderDef = Math.floor(defenderDef * COMBAT_EFFECTS.DEFEND_DEFENSE_MULTIPLIER);
                }
                // Boss H·ªìn Ma Qu·ª∑ Quy·ªát (B·ªè qua DEF)
                if (attacker.isBoss && attacker.ignoreDef) {
                     defenderDef = Math.floor(defenderDef * (1 - attacker.ignoreDef)); // B·ªè qua 50% DEF
                }
            }
            
            // C√¥ng th·ª©c s√°t th∆∞∆°ng c·ªë ƒë·ªãnh: ATK - DEF/2
            let damage = Math.max(1, attackerAtk - Math.floor(defenderDef / 2));
            
            // Th√™m ng·∫´u nhi√™n 0-20% s√°t th∆∞∆°ng
            damage = Math.floor(damage * (1 + Math.random() * 0.2));

            return damage;
        }

        // H√†m m·ªõi ƒë·ªÉ d·ª´ng tr·∫≠n ƒë·∫•u
        function stopFight() {
            isInFight = false;
            currentEnemy = null;
            bossTurnCount = 0; // Reset
            // X√≥a hi·ªáu ·ª©ng chi·∫øn thu·∫≠t, gi·ªØ l·∫°i hi·ªáu ·ª©ng ti√™u c·ª±c k√©o d√†i (slowed, poisoned, stunned)
            game.playerStatusEffects.focused = false;
            game.playerStatusEffects.defending = false;
            
            updateControls();
            updateUI();
            saveGame();
        }

        // H√†m ch√≠nh x·ª≠ l√Ω l∆∞·ª£t ƒë√°nh (CH·ªà X·∫¢Y RA KHI NG∆Ø·ªúI CH∆†I NH·∫§N N√öT)
        function takeTurn(action) {
            const enemy = currentEnemy;
            if (!isInFight || !enemy || game.player.hp <= 0 || enemy.hp <= 0) {
                stopFight(); 
                return;
            }
            
            // X·ª≠ l√Ω hi·ªáu ·ª©ng ti√™u c·ª±c tr∆∞·ªõc khi ng∆∞·ªùi ch∆°i h√†nh ƒë·ªông
            processStatusEffects(true); // Player pre-turn effects

            // N·∫øu ng∆∞·ªùi ch∆°i b·ªã Cho√°ng, b·ªè qua l∆∞·ª£t h√†nh ƒë·ªông c·ªßa Player
            if (game.playerStatusEffects.stunned > 0) {
                logMessage(`üòµ ${game.player.name} b·ªã Cho√°ng v√† kh√¥ng th·ªÉ h√†nh ƒë·ªông!`, 'message-error');
                // N·∫øu b·ªã cho√°ng, h√†nh ƒë·ªông ti·∫øp theo ph·∫£i l√† l∆∞·ª£t c·ªßa qu√°i v·∫≠t
                processEnemyTurn();
                return;
            }

            const p = game.player;
            const enemyName = enemy.icon + ' ' + enemy.name.split(' ')[0];
            
            // Ph√°t c√¢u c·ª≠a mi·ªáng
            logMessage(`${p.name}: "${CATCHPHRASES[p.name]}"`, 'message-info');

            // --- H√ÄNH ƒê·ªòNG C·ª¶A NG∆Ø·ªúI CH∆†I ---
            
            if (action === 'focus') {
                game.playerStatusEffects.focused = true;
                game.playerStatusEffects.defending = false; 
                logMessage(`üéØ ${p.name} T·∫≠p Trung! S√°t th∆∞∆°ng l∆∞·ª£t ti·∫øp theo s·∫Ω tƒÉng 50%!`, 'message-effect');
                
            } else if (action === 'defend') {
                game.playerStatusEffects.defending = true;
                game.playerStatusEffects.focused = false; 
                logMessage(`üõ°Ô∏è ${p.name} Ph√≤ng Th·ªß! Ph√≤ng th·ªß cho l∆∞·ª£t ƒë√°nh s·∫Øp t·ªõi tƒÉng 100%!`, 'message-effect');
                
            } else if (action === 'attack') {
                // 1. L∆∞·ª£t ch∆°i t·∫•n c√¥ng (Player -> Enemy)
                
                let playerDamage = calculateDamage(p, enemy, true); 
                let hit = true;

                // X·ª≠ l√Ω n√© tr√°nh c·ªßa Enemy
                if (enemy.evasion && Math.random() < enemy.evasion) {
                    logMessage(`‚ùå ${enemyName} ƒë√£ n√© ƒë√≤n t·∫•n c√¥ng c·ªßa ${p.name}!`, 'warn');
                    hit = false;
                }
                
                if (hit) {
                    enemy.hp -= playerDamage;
                    logMessage(`${p.name} t·∫•n c√¥ng! üí• G√¢y ${playerDamage} s√°t th∆∞∆°ng l√™n ${enemyName}. (HP c√≤n: ${Math.max(0, enemy.hp)})`, 'message-damage');

                    // X·ª≠ l√Ω Ph·∫£n S√°t Th∆∞∆°ng
                    if (enemy.reflect) {
                        const reflectedDamage = Math.max(1, Math.floor(playerDamage * enemy.reflect));
                        p.hp -= reflectedDamage;
                        logMessage(`üåä ${enemyName} ph·∫£n l·∫°i! üíî ${p.name} ch·ªãu ${reflectedDamage} s√°t th∆∞∆°ng ph·∫£n h·ªìi.`, 'message-error');
                    }
                }
                
                // Sau khi ƒë√°nh, x√≥a hi·ªáu ·ª©ng Focused
                game.playerStatusEffects.focused = false;
            }

            // Ki·ªÉm tra Enemy ch·∫øt SAU L∆Ø·ª¢T ƒê√ÅNH C·ª¶A PLAYER
            if (enemy.hp <= 0) {
                endFight(true, enemy);
                return;
            }
            
            // --- CHUY·ªÇN SANG L∆Ø·ª¢T ENEMY (b·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫•n c√¥ng) ---
            processEnemyTurn();
        }

        function processStatusEffects(preTurn) {
             const p = game.player;
             // Gi·∫£m th·ªùi gian hi·ªáu ·ª©ng 
             if (game.playerStatusEffects.slowed > 0) game.playerStatusEffects.slowed--;
             if (game.playerStatusEffects.stunned > 0) game.playerStatusEffects.stunned--;
             
             // X·ª≠ l√Ω s√°t th∆∞∆°ng ƒë·ªôc (ng∆∞·ªùi ch∆°i)
             if (game.playerStatusEffects.poisoned > 0) {
                game.playerStatusEffects.poisoned--;
                const poisonDamage = 5;
                p.hp -= poisonDamage;
                logMessage(`‚ò£Ô∏è ${p.name} m·∫•t ${poisonDamage} HP v√¨ Tr√∫ng ƒê·ªôc.`, 'message-error');
             }

             // X·ª≠ l√Ω h·ªìi m√°u Boss (Boss B∆∞·ªõm)
             if (currentEnemy && currentEnemy.isFinalBoss && currentEnemy.healTurn && preTurn === false) { // Ch·ªâ ki·ªÉm tra sau khi player ƒë√£ ƒë√°nh xong
                 bossTurnCount++;
                 if (bossTurnCount % currentEnemy.healTurn === 0) {
                     const heal = currentEnemy.healAmount;
                     currentEnemy.hp = Math.min(currentEnemy.hp + heal, currentEnemy.maxHp);
                     logMessage(`ü¶ã ${currentEnemy.icon} ${currentEnemy.name} h·ªìi ${heal} HP!`, 'message-effect');
                 }
             }

        }

        function processEnemyTurn() {
            const enemy = currentEnemy;
            const p = game.player;
            const enemyName = enemy.icon + ' ' + enemy.name.split(' ')[0];

            // Ki·ªÉm tra Player ch·∫øt do ph·∫£n s√°t th∆∞∆°ng/ƒë·ªôc (tr∆∞·ªõc khi qu√°i ƒë√°nh)
            if (p.hp <= 0) {
                endFight(false, enemy);
                return;
            }

            // --- X·ª¨ L√ù MINI BOSS N·ªòI T·∫†I (Tr∆∞·ªõc khi t·∫•n c√¥ng) ---
            let attackCount = 1;
            // Boss Chim Kh·ªïng L·ªì (ƒê√°nh 2 l·∫ßn)
            if (enemy.doubleAttack && Math.random() < enemy.doubleAttack) {
                 attackCount = 2;
                 logMessage(`ü¶Ö ${enemyName} T·∫•n c√¥ng hai l·∫ßn!`, 'message-warn');
            }
            // Boss Heo R·ª´ng C∆°n Gi·∫≠n (TƒÉng ATK khi HP th·∫•p)
            if (enemy.rage && enemy.hp / enemy.maxHp <= enemy.rage) {
                enemy.atk = Math.floor(enemy.baseAtk * 1.5); // TƒÉng 50% ATK
                logMessage(`üêó ${enemyName} n·ªïi c∆°n th·ªãnh n·ªô! ATK tƒÉng!`, 'message-error');
            }
            // Boss Ch√≠nh Thi√™n Th·∫ßn Sa Ng√£ (ƒê√£ x·ª≠ l√Ω ·ªü endFight)

            // --- B·∫ÆT ƒê·∫¶U T·∫§N C√îNG ---
            for (let i = 0; i < attackCount; i++) {
                if (p.hp <= 0) break; // Tho√°t n·∫øu ng∆∞·ªùi ch∆°i ch·∫øt sau c√∫ ƒë√°nh ƒë·∫ßu ti√™n
                
                const enemyDamage = calculateDamage(enemy, p, false); 
                p.hp -= enemyDamage;
                logMessage(`${enemyName} t·∫•n c√¥ng! üíî ${p.name} ch·ªãu ${enemyDamage} s√°t th∆∞∆°ng. (HP c√≤n: ${Math.max(0, p.hp)})`, 'message-damage');

                // X·ª≠ l√Ω hi·ªáu ·ª©ng Cho√°ng c·ªßa Boss Qu√°i V·∫≠t T√≠ Hon
                if (enemy.isFinalBoss && enemy.stunChance && Math.random() < enemy.stunChance && game.playerStatusEffects.stunned === 0) {
                    game.playerStatusEffects.stunned = 1; 
                    logMessage(`üëπ ${enemyName} g√¢y hi·ªáu ·ª©ng Cho√°ng! (${p.name} m·∫•t 1 l∆∞·ª£t)`, 'message-effect');
                }
                
                // X·ª≠ l√Ω hi·ªáu ·ª©ng ƒê·ªôc c·ªßa Boss B√≤ S√°t ƒê·ªôc
                if (enemy.poison && Math.random() < enemy.poison && game.playerStatusEffects.poisoned === 0) {
                    game.playerStatusEffects.poisoned = 3; // K√©o d√†i 3 l∆∞·ª£t
                    logMessage(`ü¶ñ ${enemyName} gieo ƒê·ªôc! (${p.name} m·∫•t HP trong 3 l∆∞·ª£t)`, 'message-error');
                }
                
                // X·ª≠ l√Ω gi·∫£m DEF vƒ©nh vi·ªÖn c·ªßa Boss Ch√≠nh Thi√™n Th·∫ßn Sa Ng√£
                if (enemy.isFinalBoss && enemy.defDebuff && Math.random() < enemy.defDebuff) {
                    p.def = Math.max(1, p.def - 2); // Gi·∫£m 2 DEF
                    p.maxHp = Math.max(p.maxHp, p.hp); // N·∫øu HP b·ªã gi·∫£m d∆∞·ªõi 0, th√¨ s·∫Ω ch·∫øt
                    logMessage(`üòá ${enemyName} l√†m suy gi·∫£m s·ª©c m·∫°nh! DEF vƒ©nh vi·ªÖn c·ªßa ${p.name} gi·∫£m -2!`, 'message-error');
                }
            }
            
            // X√≥a hi·ªáu ·ª©ng Defending sau khi b·ªã qu√°i ƒë√°nh
            game.playerStatusEffects.defending = false;

            // Ki·ªÉm tra Player ch·∫øt SAU L∆Ø·ª¢T ƒê√ÅNH C·ª¶A ENEMY
            if (p.hp <= 0) {
                endFight(false, enemy);
                return;
            }
            
            // C·∫≠p nh·∫≠t giao di·ªán sau khi ho√†n th√†nh 1 l∆∞·ª£t
            updateUI();
            updateControls();
        }

        
        // H√†m m·ªõi ƒë·ªÉ x·ª≠ l√Ω k·∫øt th√∫c tr·∫≠n ƒë·∫•u (Th·∫Øng ho·∫∑c Thua)
        function endFight(playerWon, enemy) {
             const p = game.player;
             const enemyName = enemy.icon + ' ' + enemy.name.split(' ')[0];
                
             if (playerWon) {
                logMessage(`‚úÖ ${enemyName} ƒë√£ b·ªã ƒë√°nh b·∫°i t·∫°i ${enemy.location || 'L√†ng'}!`, 'message-info');
                
                // Thu th·∫≠p Chicoin
                const coinDrop = Math.floor(Math.random() * (enemy.dropCoin.max - enemy.dropCoin.min + 1)) + enemy.dropCoin.min;
                gainChicoin(coinDrop);

                if (enemy.isBoss) {
                    lootItem(enemy.item);
                    gainExp(enemy.exp);
                    
                    if (enemy.isFinalBoss) {
                         game.finalBossesDefeated.push(enemy.name);
                         logMessage(`üëë CH√öC M·ª™NG! B·∫°n ƒë√£ ƒë√°nh b·∫°i Boss Ch√≠nh ${enemy.name}!`, 'message-quest');
                    } else {
                         game.bossDefeated = true; // Ch·ªâ ƒë·ªÉ m·ªü kh√≥a Boss Ch√≠nh (n·∫øu c·∫ßn)
                    }
                } else {
                    // C·∫≠p nh·∫≠t nhi·ªám v·ª• (ƒë√°nh qu√°i th∆∞·ªùng)
                    if (game.quest.active) {
                         game.quest.currentCount++;
                         const progress = `${game.quest.currentCount}/${game.quest.requiredCount}`;
                         logMessage(`Ti·∫øn ƒë·ªô Nhi·ªám v·ª•: ${progress}`, 'quest');
                        if (game.quest.currentCount >= game.quest.requiredCount) {
                            completeQuest();
                        }
                    }
                    gainExp(enemy.exp); 
                }
             } else {
                logMessage(`üíÄ ${p.name} ƒë√£ ng√£ xu·ªëng tr∆∞·ªõc ${enemyName}... Cu·ªôc phi√™u l∆∞u k·∫øt th√∫c.`, 'message-error');
                logMessage(`Vui l√≤ng ch·ªçn nh√¢n v·∫≠t m·ªõi ƒë·ªÉ ch∆°i l·∫°i!`, 'message-error');
                
                // T·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i game v·ªÅ m√†n h√¨nh ch·ªçn nh√¢n v·∫≠t
                game = null; 
                switchView('selection');
             }

             stopFight(); // D·ª´ng tr·∫°ng th√°i chi·∫øn ƒë·∫•u v√† c·∫≠p nh·∫≠t ƒëi·ªÅu khi·ªÉn/giao di·ªán
        }


        // B·∫Øt ƒë·∫ßu chi·∫øn ƒë·∫•u Qu√°i th∆∞·ªùng (Ng·∫´u nhi√™n trong 20 lo·∫°i)
        function startQuestFight() {
            if (game.quest.currentCount >= game.quest.requiredCount) {
                 logMessage("Nhi·ªám v·ª• ƒë√£ ho√†n th√†nh. H√£y nh·∫≠n ph·∫ßn th∆∞·ªüng!", 'warn');
                 return;
            }
            if (isInFight) {
                 logMessage("B·∫°n ƒëang trong tr·∫≠n chi·∫øn kh√°c!", 'warn');
                 return;
            }

            const enemyKeys = Object.keys(NORMAL_ENEMY_POOL);
            const randomEnemyKey = enemyKeys[Math.floor(Math.random() * enemyKeys.length)];
            const config = NORMAL_ENEMY_POOL[randomEnemyKey];

            // Thi·∫øt l·∫≠p currentEnemy (Kh√¥ng ph·∫£i Boss)
            currentEnemy = { 
                ...config, 
                name: randomEnemyKey,
                maxHp: config.hp, 
                hp: config.hp, 
                isBoss: false,
                isFinalBoss: false,
                location: 'Village',
                evasion: config.evasion || 0,
                // C√°c hi·ªáu ·ª©ng kh√°c c√≥ th·ªÉ ƒë∆∞·ª£c th√™m v√†o ƒë√¢y
            };
            
            isInFight = true;
            cakeUsedInFight = false;
            
            logMessage(`B·∫Øt ƒë·∫ßu chi·∫øn ƒë·∫•u v·ªõi Qu√°i Th∆∞·ªùng: ${currentEnemy.icon} ${currentEnemy.name}!`, 'message-warn');
            logMessage(`ƒê·∫∑c ƒëi·ªÉm: ${config.special}`, 'message-effect');
            
            updateUI();
            updateControls();
        }

        // B·∫Øt ƒë·∫ßu chi·∫øn ƒë·∫•u Mini Boss Ng·∫´u Nhi√™n
        function startRandomBossFight() {
            if (isInFight) {
                 logMessage("B·∫°n ƒëang trong tr·∫≠n chi·∫øn kh√°c!", 'warn');
                 return;
            }
            
            const bossKeys = Object.keys(MINI_BOSS_POOL);
            const randomBossKey = bossKeys[Math.floor(Math.random() * bossKeys.length)];
            const bossConfig = MINI_BOSS_POOL[randomBossKey];

            // Thi·∫øt l·∫≠p currentEnemy (L√† Mini Boss)
            currentEnemy = {
                ...bossConfig,
                name: randomBossKey,
                type: randomBossKey, // D√πng ƒë·ªÉ x√°c ƒë·ªãnh hi·ªáu ·ª©ng
                maxHp: bossConfig.hp,
                hp: bossConfig.hp,
                isBoss: true,
                isFinalBoss: false,
                baseAtk: bossConfig.atk, // L∆∞u ATK g·ªëc cho Boss Heo R·ª´ng
                evasion: bossConfig.evasion || 0,
                reflect: bossConfig.reflect || 0,
                poison: bossConfig.poison || 0,
                doubleAttack: bossConfig.doubleAttack || 0,
                ignoreDef: bossConfig.ignoreDef || 0,
                rage: bossConfig.rage || 0
            };

            isInFight = true;
            cakeUsedInFight = false;

            logMessage(`‚öîÔ∏è ƒê·ªëi ƒë·∫ßu v·ªõi Mini Boss ${currentEnemy.icon} ${currentEnemy.name} t·∫°i ${currentEnemy.location}! C·∫©n th·∫≠n!`, 'message-error');
            logMessage(`ƒê·∫∑c ƒëi·ªÉm: ${bossConfig.special}`, 'message-effect');
            
            updateUI();
            updateControls();
        }

        // B·∫Øt ƒë·∫ßu chi·∫øn ƒë·∫•u Boss Ch√≠nh (T·ª´ m√†n h√¨nh Final Boss)
        function startFinalBossFight(bossName) {
            if (isInFight) {
                 logMessage("B·∫°n ƒëang trong tr·∫≠n chi·∫øn kh√°c!", 'warn');
                 return;
            }
            
            const bossConfig = FINAL_BOSS_POOL[bossName];
            if (!bossConfig) {
                 logMessage("L·ªñI: Kh√¥ng t√¨m th·∫•y Boss Ch√≠nh n√†y.", 'error');
                 return;
            }

            // Thi·∫øt l·∫≠p currentEnemy (L√† Final Boss)
            currentEnemy = {
                ...bossConfig,
                name: bossName,
                type: bossName, 
                maxHp: bossConfig.hp,
                hp: bossConfig.hp,
                isBoss: true,
                isFinalBoss: true,
                baseAtk: bossConfig.atk, 
                healTurn: bossConfig.healTurn || 0,
                healAmount: bossConfig.healAmount || 0,
                stunChance: bossConfig.stunChance || 0,
                defDebuff: bossConfig.defDebuff || 0,
                dropCoin: bossConfig.dropCoin
            };
            
            bossTurnCount = 0; // Reset l∆∞·ª£t boss

            isInFight = true;
            cakeUsedInFight = false;
            switchView('main'); // Chuy·ªÉn v·ªÅ m√†n h√¨nh ch√≠nh ƒë·ªÉ chi·∫øn ƒë·∫•u

            logMessage(`üî• CH√çNH TH·ª®C: ƒê·ªëi ƒë·∫ßu v·ªõi BOSS CH√çNH ${currentEnemy.icon} ${currentEnemy.name}!`, 'message-error');
            logMessage(`ƒê·∫∑c ƒëi·ªÉm: ${bossConfig.special}`, 'message-error');
            
            updateUI();
            updateControls();
        }

        function completeQuest() {
            const reward = game.quest.reward;
            logMessage(`üèÜ NHI·ªÜM V·ª§ HO√ÄN TH√ÄNH: ${game.quest.name}!`, 'message-quest');
            
            if (reward.item) {
                lootItem(reward.item);
                if (reward.item === 'G·∫≠y G·ªó' && game.player.weapon === 'Kh√¥ng') {
                    equipWeapon('G·∫≠y G·ªó');
                }
            }

            game.quest.active = false;
            logMessage(`B√¢y gi·ªù b·∫°n ƒë√£ s·∫µn s√†ng kh√°m ph√° v√† ƒë·ªëi ƒë·∫ßu v·ªõi c√°c Mini Boss ·ªü nhi·ªÅu khu v·ª±c kh√°c nhau!`, 'message-error');
            updateControls();
            saveGame();
        }
        
        // --- H·ªÜ TH·ªêNG SHOP ---

        function renderShop() {
            const foodGrid = document.getElementById('foodShopGrid');
            const weaponGrid = document.getElementById('weaponShopGrid');
            foodGrid.innerHTML = '';
            weaponGrid.innerHTML = '';

            // Render ƒê·ªì ƒÇn
            for (const name in FOOD_ITEMS) {
                const item = FOOD_ITEMS[name];
                const card = document.createElement('div');
                card.className = 'shop-item-card';
                card.innerHTML = `
                    <h4>${name}</h4>
                    <p>${item.description}</p>
                    <div class="shop-price">üí∞ ${item.price} Chicoin</div>
                `;
                card.onclick = () => buyItem('food', name, item);
                foodGrid.appendChild(card);
            }

            // Render V≈© Kh√≠
            for (const name in WEAPONS_SHOP) {
                const item = WEAPONS_SHOP[name];
                const card = document.createElement('div');
                card.className = 'shop-item-card';
                card.innerHTML = `
                    <h4>${name}</h4>
                    <p>ATK +${item.atk}, DEF +${item.def}</p>
                    <p>${item.description}</p>
                    <div class="shop-price">üí∞ ${item.price} Chicoin</div>
                `;
                card.onclick = () => buyItem('weapon', name, item);
                weaponGrid.appendChild(card);
            }
        }

        function buyItem(type, name, item) {
            const p = game.player;

            // Ki·ªÉm tra ti·ªÅn
            if (p.chicoin < item.price) {
                logMessage(`üí∞ B·∫°n kh√¥ng ƒë·ªß Chicoin (${p.chicoin}/${item.price}) ƒë·ªÉ mua ${name}!`, 'error');
                return;
            }

            // Ki·ªÉm tra HP ƒë·∫ßy khi mua ƒë·ªì ƒÉn
            if (type === 'food' && p.hp === p.maxHp && (p.inventory[name] || 0) > 0) {
                 logMessage("HP ƒë√£ ƒë·∫ßy v√† b·∫°n ƒë√£ c√≥ v·∫≠t ph·∫©m n√†y. Vui l√≤ng d√πng h·∫øt m√≥n c≈© ho·∫∑c quay l·∫°i sau.", 'warn');
                 return;
            }


            // Tr·ª´ ti·ªÅn
            p.chicoin -= item.price;
            logMessage(`ƒê√£ mua ${name} v·ªõi gi√° üí∞ ${item.price} Chicoin.`, 'message-coin');

            // Th√™m v·∫≠t ph·∫©m v√†o t√∫i ƒë·ªì
            if (type === 'food') {
                if (FOOD_ITEMS[name]) {
                    if (p.inventory[name] === undefined) {
                        p.inventory[name] = 0;
                    }
                    p.inventory[name]++;
                } else {
                    logMessage(`L·ªñI: V·∫≠t ph·∫©m h·ªìi m√°u ${name} kh√¥ng t·ªìn t·∫°i.`, 'error');
                }
            } else if (type === 'weapon') {
                if (WEAPONS_SHOP[name]) {
                    if (p.inventory[name] === undefined) {
                        p.inventory[name] = 0;
                    }
                    p.inventory[name]++;
                    const currentWeapon = WEAPONS[p.weapon] || WEAPONS['Kh√¥ng'];
                    if (p.weapon === 'Kh√¥ng' || item.atk + item.def > currentWeapon.atk + currentWeapon.def) {
                        equipWeapon(name);
                    }
                } else {
                    logMessage(`L·ªñI: V≈© kh√≠ ${name} kh√¥ng t·ªìn t·∫°i.`, 'error');
                }
            }

            updateUI();
            saveGame();
        }
        
        // --- H·ªÜ TH·ªêNG BOSS CH√çNH ---

        function renderFinalBosses() {
             const bossGrid = document.getElementById('finalBossGrid');
             bossGrid.innerHTML = '';
             
             for (const name in FINAL_BOSS_POOL) {
                 const boss = FINAL_BOSS_POOL[name];
                 const isDefeated = game.finalBossesDefeated.includes(name);
                 const card = document.createElement('div');
                 card.className = 'shop-item-card';
                 card.style.backgroundColor = isDefeated ? '#bbf7d0' : '#fee2e2';
                 
                 card.innerHTML = `
                     <h4>${boss.icon} ${name}</h4>
                     <p style="font-weight: bold;">HP: ${boss.hp} | ATK: ${boss.atk} | DEF: ${boss.def}</p>
                     <p style="font-size: 0.9rem; margin-bottom: 8px;">ƒê·∫∑c ƒëi·ªÉm: ${boss.special}</p>
                     <div class="shop-price">${isDefeated ? '‚úÖ ƒê√É ƒê√ÅNH B·∫†I' : 'üî• TH·ª¨ TH√ÅCH'}</div>
                 `;
                 
                 if (!isDefeated) {
                     card.onclick = () => {
                         if (game.player.hp < game.player.maxHp) {
                             logMessage("HP ch∆∞a ƒë·∫ßy! H√£y ngh·ªâ ng∆°i tr∆∞·ªõc khi ƒë·ªëi ƒë·∫ßu v·ªõi Boss Ch√≠nh!", 'error');
                             return;
                         }
                         if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë·ªëi ƒë·∫ßu v·ªõi BOSS CH√çNH ${name}?`)) {
                             startFinalBossFight(name);
                         }
                     };
                 } else {
                     card.style.cursor = 'default';
                 }
                 
                 bossGrid.appendChild(card);
             }
        }


        // --- KH·ªûI ƒê·ªòNG BAN ƒê·∫¶U ---

        window.onload = () => {
            setupMusic(); 
            // Thay th·∫ø confirm() b·∫±ng modal/log message
            window.confirm = (message) => {
                 logMessage(`(C·∫ßn x√°c nh·∫≠n: ${message}) - Ti·∫øp t·ª•c b·∫±ng c√°ch nh·∫•p l·∫°i n√∫t h√†nh ƒë·ªông.`, 'warn');
                 return true;
            };

            if (window.isFirebaseAvailable === false || typeof __firebase_config === 'undefined' || JSON.parse(__firebase_config).projectId === 'YOUR_PROJECT_ID') {
                document.getElementById('saveLoadStatus').textContent = "Ch·∫ø ƒë·ªô Offline: Kh√¥ng th·ªÉ l∆∞u game.";
            }
        };

    </script>
</body>
</html>
